# F1T 賽道分析模組 - 整體三層架構詳細說明

## 📋 文檔資訊
- **文檔類型**: 架構詳細說明
- **創建日期**: 2025-08-27
- **模組名稱**: TrackAnalysisModule
- **功能概述**: F1 賽道視覺化分析與控制系統

## 🏗️ 整體三層架構概覽

```
┌───────────────────────────────────────────────────────────────────┐
│                        第一層：頂部控制面板                        │
│                      (Control Panel - 70px)                     │
├───────────────────────────────────────────────────────────────────┤
│                      第二層：主要內容區域                          │
│                    (Main Content - 可變高度)                     │
│  ┌─────────────────────────┬─────────────────────────────────────┐  │
│  │   左側：賽道地圖區域      │      右側：資訊面板區域              │  │
│  │   (Track Map Area)     │    (Information Panel)            │  │
│  │                        │                                   │  │
│  │      3:1 分割比例       │                                   │  │
│  └─────────────────────────┴─────────────────────────────────────┘  │
├───────────────────────────────────────────────────────────────────┤
│                       第三層：底部狀態區域                         │
│                      (Status Area - 25px)                       │
└───────────────────────────────────────────────────────────────────┘
```

---

## 🎛️ 第一層：頂部控制面板 (Control Panel)

### 📐 整體特性
- **容器類型**: QWidget
- **高度**: 70px (固定)
- **布局**: QVBoxLayout (雙行垂直排列)
- **背景色**: #f8f9fa (Bootstrap 淺灰)
- **邊框**: 1px solid #dee2e6 + 5px 圓角
- **邊距**: 上下5px, 左右10px
- **間距**: 5px

### 🔝 第一行：主要功能控制區

#### 📊 布局結構
```
QHBoxLayout (水平布局)
├── 標題標籤 (左對齊)
├── 彈性空間 (addStretch)
├── 重新載入按鈕 (右對齊)
└── 匯出按鈕 (右對齊)
```

#### 🏷️ 標題標籤
- **類型**: QLabel
- **內容**: `"賽道分析 - {year} {race} {session}"`
- **範例**: `"賽道分析 - 2025 Japan R"`
- **字體**: Microsoft YaHei, 10pt, Bold
- **顏色**: 系統預設文字色
- **功能**: 顯示當前分析的賽事資訊

#### 🔄 重新載入按鈕
```python
self.reload_btn = QPushButton("🔄 重新載入")
self.reload_btn.setFixedSize(80, 30)
self.reload_btn.clicked.connect(self.reload_analysis)
```
- **尺寸**: 80×30 像素
- **圖示**: 🔄 (旋轉箭頭)
- **文字**: "重新載入"
- **功能**: 重新執行賽道分析流程
- **觸發動作**: 
  1. 清除現有數據
  2. 重新執行CLI功能2
  3. 重新載入JSON數據
  4. 更新地圖和資訊面板
- **狀態更新**: 按鈕點擊後顯示"執行賽道分析中..."

#### 📄 匯出按鈕
```python
self.export_btn = QPushButton("📄 匯出")
self.export_btn.setFixedSize(60, 30)
self.export_btn.clicked.connect(self.export_track_map)
```
- **尺寸**: 60×30 像素
- **圖示**: 📄 (文件圖示)
- **文字**: "匯出"
- **功能**: 匯出賽道分析數據
- **匯出格式**: JSON 檔案
- **檔案命名**: `track_analysis_{年份}_{賽事}_{會話}_{日期}.json`
- **儲存位置**: `{專案根目錄}/exports/`
- **錯誤處理**: 無數據時顯示提示訊息

### 🔽 第二行：顯示選項控制區

#### 📊 布局結構
```
QHBoxLayout (水平布局)
├── "顯示選項:" 標籤
├── 起始點複選框
├── 結束點複選框  
├── 距離標記複選框
├── START/FINISH標籤複選框
└── 彈性空間 (addStretch)
```

#### 🏷️ 顯示選項標籤
- **類型**: QLabel
- **內容**: "顯示選項:"
- **字體**: Microsoft YaHei, 9pt
- **作用**: 提示用戶以下為顯示控制選項

#### ☑️ 起始點複選框
```python
self.show_start_checkbox = QCheckBox("起始點")
self.show_start_checkbox.setChecked(True)  # 預設勾選
self.show_start_checkbox.stateChanged.connect(self.update_display_options)
```
- **標籤**: "起始點"
- **預設狀態**: 勾選 (True)
- **控制對象**: 地圖上的綠色起始點圓圈
- **視覺效果**: 
  - ✅ 勾選：顯示綠色半透明圓圈 (RGB: 0,255,0,180)
  - ❌ 取消：隱藏起始點標記
- **圓圈規格**: 8×8像素，位於賽道起始位置
- **即時更新**: 狀態變更立即反映在地圖上

#### ☑️ 結束點複選框
```python
self.show_finish_checkbox = QCheckBox("結束點")
self.show_finish_checkbox.setChecked(True)  # 預設勾選
self.show_finish_checkbox.stateChanged.connect(self.update_display_options)
```
- **標籤**: "結束點"
- **預設狀態**: 勾選 (True)
- **控制對象**: 地圖上的紅色結束點圓圈
- **視覺效果**:
  - ✅ 勾選：顯示紅色半透明圓圈 (RGB: 255,0,0,180)
  - ❌ 取消：隱藏結束點標記
- **圓圈規格**: 8×8像素，位於賽道結束位置
- **特殊說明**: 通常與起始點位置相同或相近

#### ☑️ 距離標記複選框
```python
self.show_markers_checkbox = QCheckBox("距離標記")
self.show_markers_checkbox.setChecked(True)  # 預設勾選
self.show_markers_checkbox.stateChanged.connect(self.update_display_options)
```
- **標籤**: "距離標記"
- **預設狀態**: 勾選 (True)
- **控制對象**: 沿賽道分布的藍色距離參考點
- **視覺效果**:
  - ✅ 勾選：顯示藍色距離標記點
  - ❌ 取消：隱藏所有距離標記
- **標記特性**: 
  - 顏色：藍色 (RGB: 100,100,255,180)
  - 間距：根據賽道長度自動分布
  - 用途：提供距離參考和位置導航

#### ☑️ START/FINISH標籤複選框
```python
self.show_labels_checkbox = QCheckBox("START/FINISH標籤")
self.show_labels_checkbox.setChecked(True)  # 預設勾選
self.show_labels_checkbox.stateChanged.connect(self.update_display_options)
```
- **標籤**: "START/FINISH標籤"
- **預設狀態**: 勾選 (True)
- **控制對象**: 起始和結束位置的文字標籤
- **視覺效果**:
  - ✅ 勾選：顯示"START"和"FINISH"文字
  - ❌ 取消：隱藏文字標籤
- **文字特性**:
  - 字體：系統預設字體
  - 顏色：與對應圓圈顏色搭配
  - 位置：緊鄰對應的圓圈標記

#### 🔄 共同更新機制
```python
def update_display_options(self):
    """更新賽道地圖顯示選項"""
    show_start = self.show_start_checkbox.isChecked()
    show_finish = self.show_finish_checkbox.isChecked()
    show_markers = self.show_markers_checkbox.isChecked()
    show_labels = self.show_labels_checkbox.isChecked()
    
    # 更新地圖顯示選項
    self.track_map.set_display_options(show_start, show_finish, show_markers, show_labels)
```
- **觸發時機**: 任何複選框狀態變更
- **更新範圍**: 所有顯示選項同時更新
- **響應速度**: 即時 (無延遲)
- **日誌輸出**: 記錄每次變更的詳細狀態

---

## 🖼️ 第二層：主要內容區域 (Main Content)

### 📐 整體特性
- **容器類型**: QSplitter (水平分割)
- **分割方向**: Qt.Horizontal
- **預設比例**: 3:1 (地圖:資訊 = 600:200)
- **可調整性**: 用戶可拖拽分割線調整比例
- **最小限制**: 地圖區域最小 400×300 像素

### 🗺️ 左側：賽道地圖區域

#### 📊 容器結構
```
QGroupBox: "賽道地圖"
└── QVBoxLayout
    └── TrackMapWidget (自定義繪製組件)
        ├── 背景繪製
        ├── 賽道線條 (QPainterPath)
        ├── 起始點標記 (條件顯示)
        ├── 結束點標記 (條件顯示)
        ├── 距離標記 (條件顯示)
        ├── 文字標籤 (條件顯示)
        └── 圖例 (動態更新)
```

#### 🎨 TrackMapWidget 特性
- **繼承類別**: QWidget
- **最小尺寸**: 400×300 像素
- **背景色**: 白色
- **邊框**: 1px solid #ccc
- **繪製引擎**: QPainter + QPainterPath
- **座標系統**: 自動縮放的世界座標系

#### 🎯 繪製元素詳解

**賽道線條**:
- **技術**: QPainterPath 平滑路徑
- **顏色**: 藍色 (#0066cc)
- **寬度**: 2像素
- **特性**: 反鋸齒平滑曲線
- **數據來源**: JSON 位置點座標

**起始點標記**:
- **形狀**: 圓形 (QEllipse)
- **尺寸**: 8×8 像素
- **顏色**: RGB(0,255,0,180) - 綠色半透明
- **位置**: 賽道數據第一個點
- **顯示條件**: 起始點複選框勾選

**結束點標記**:
- **形狀**: 圓形 (QEllipse)  
- **尺寸**: 8×8 像素
- **顏色**: RGB(255,0,0,180) - 紅色半透明
- **位置**: 賽道數據最後一個點
- **顯示條件**: 結束點複選框勾選

**距離標記**:
- **形狀**: 小圓點
- **顏色**: RGB(100,100,255,180) - 藍色半透明
- **分布**: 沿賽道均勻分布
- **顯示條件**: 距離標記複選框勾選

**文字標籤**:
- **內容**: "START", "FINISH"
- **字體**: 系統預設
- **位置**: 緊鄰對應標記點
- **顯示條件**: 標籤複選框勾選

**動態圖例**:
- **位置**: 左上角
- **內容**: 僅顯示當前啟用的元素
- **背景**: 半透明白色
- **更新**: 隨複選框狀態動態變更

### 📊 右側：資訊面板區域

#### 📋 三區塊結構
```
QGroupBox: "賽道資訊"
└── QVBoxLayout
    ├── 基本資訊區塊 (Basic Info Section)
    ├── 統計資訊區塊 (Statistics Section)  
    └── 詳細資訊區塊 (Details Section)
```

#### 📝 基本資訊區塊
```
QGroupBox: "基本資訊"
├── 賽事名稱: "Japanese Grand Prix"
├── 賽道長度: "57.620 km"  
├── 圈數數量: "50"
└── 座標範圍: "X(-13796 ~ 5962), Y(-7004 ~ 3135)"
```
- **數據來源**: JSON 檔案解析
- **更新時機**: 重新載入分析時
- **顯示格式**: 標籤-值對

#### 📈 統計資訊區塊
```
QGroupBox: "統計資訊"  
├── 最快圈: "ANT (第50圈) - 00:01:30.965000"
└── 數據品質: "良好"
```
- **最快圈**: 從遙測數據計算
- **數據品質**: 根據數據完整性評估
- **格式**: 車手代碼 + 圈數 + 時間

#### 📋 詳細資訊區塊
```
QScrollArea (可滾動)
└── "位置點詳細列表 (前10個圈):"
    ├── # 1: 距離=0.0m, X=1674, Y=-613
    ├── # 2: 距離=1479.5m, X=2636, Y=-1743  
    ├── # 3: 距離=2814.3m, X=3504, Y=-2757
    └── ...
```
- **滾動支援**: QScrollArea 容器
- **數據格式**: 序號、距離、X座標、Y座標
- **顯示限制**: 前10個位置點
- **更新**: 隨地圖數據同步更新

---

## 📊 第三層：底部狀態區域 (Status Area)

### 📐 整體特性
- **高度**: 25px (固定)
- **布局**: QHBoxLayout (水平布局)
- **功能**: 顯示系統狀態和進度

### 🏷️ 狀態標籤
```python
self.status_label = QLabel("狀態: 準備中...")
self.status_label.setFixedHeight(25)
```
- **背景色**: #e9ecef (淺灰)
- **邊框**: 1px solid #ced4da + 3px 圓角
- **字體大小**: 11px
- **內邊距**: 3px 8px
- **狀態變化**:
  - 初始化: "狀態: 準備中..."
  - 載入中: "狀態: 執行賽道分析中..."
  - 完成: "狀態: 分析完成"
  - 錯誤: "狀態: 分析失敗 - {錯誤訊息}"

### 📊 進度條
```python
self.progress_bar = QProgressBar()
self.progress_bar.setVisible(False)  # 預設隱藏
self.progress_bar.setFixedHeight(20)
```
- **預設狀態**: 隱藏
- **顯示時機**: 執行耗時操作時
- **進度範圍**: 0-100%
- **視覺效果**: 標準進度條樣式

---

## 🔄 架構交互流程

### 📥 數據流向
```
CLI分析 → JSON檔案 → 數據載入 → 座標轉換 → 地圖繪製 → 資訊展示
   ↑                                                      ↓
複選框控制 ← UI更新 ← 即時響應 ← 狀態變更 ← 事件觸發 ← 用戶操作
```

### 🎮 用戶操作響應
1. **複選框變更** → `update_display_options()` → 地圖重繪
2. **重新載入按鈕** → `reload_analysis()` → 完整流程重啟
3. **匯出按鈕** → `export_track_map()` → JSON檔案輸出
4. **分割線拖拽** → 自動調整布局比例

### ⚡ 性能優化
- **條件繪製**: 僅繪製啟用的元素
- **緩存機制**: 避免重複數據載入  
- **即時響應**: UI控制無延遲更新
- **記憶體管理**: 適當的垃圾回收

---

## 🎯 設計優勢總結

### ✅ 架構優點
1. **清晰分層**: 功能區域明確分離
2. **模組化**: 各組件職責獨立
3. **響應式**: 即時UI反饋
4. **可擴展**: 易於添加新功能

### ✅ 用戶體驗
1. **直觀操作**: 複選框控制清晰
2. **豐富資訊**: 完整的賽道數據展示
3. **靈活布局**: 可調整的分割比例
4. **視覺回饋**: 詳細的狀態提示

### ✅ 技術特點
1. **平滑繪製**: QPainterPath 高品質渲染
2. **條件顯示**: 高效的選擇性繪製
3. **座標轉換**: 精確的世界-螢幕座標映射
4. **錯誤處理**: 完整的異常處理機制

這個三層架構設計為F1賽道分析提供了專業、直觀、功能完整的用戶界面，滿足了數據視覺化和交互控制的需求。
